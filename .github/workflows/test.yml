name: Test Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  bats-tests:
    name: BATS Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Install jq for JSON validation
        run: sudo apt-get install -y jq

      - name: Install yq for YAML validation
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run BATS tests
        run: bats tests/test-plugin.bats

  frontmatter-validation:
    name: Validate Command Frontmatter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate frontmatter structure
        run: |
          errors=0
          for file in commands/*.md; do
            echo "Checking $file..."

            # Check for frontmatter markers
            if ! grep -q "^---$" "$file"; then
              echo "❌ Missing frontmatter in $file"
              errors=$((errors + 1))
            fi

            # Check for required fields
            if ! grep -q "^description:" "$file"; then
              echo "❌ Missing description in $file"
              errors=$((errors + 1))
            fi

            if ! grep -q "^allowed-tools:" "$file"; then
              echo "❌ Missing allowed-tools in $file"
              errors=$((errors + 1))
            fi
          done

          if [ $errors -gt 0 ]; then
            echo ""
            echo "Found $errors frontmatter errors"
            exit 1
          else
            echo "✅ All command files have valid frontmatter"
          fi

  documentation-build:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          path: ~/.cache/pip
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Zensical
        run: |
          python -m pip install --upgrade pip
          pip install zensical

      - name: Build documentation
        run: zensical build --clean

      - name: Check for broken links in docs
        run: |
          # Check that all internal links resolve
          find docs -name "*.md" -exec grep -h '\[.*\](.*)' {} \; | \
            grep -o '(\([^)]*\.md\))' | \
            sed 's/[()]//g' | \
            while read link; do
              if [[ "$link" =~ ^http ]]; then
                continue  # Skip external links
              fi
              # Remove anchors
              file=$(echo "$link" | cut -d'#' -f1)
              if [ -n "$file" ] && [ ! -f "docs/$file" ]; then
                echo "❌ Broken link: $link"
              fi
            done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for secrets
        run: |
          # Check for potential hardcoded secrets
          # Exclude audit-security.md and audit-live-site.md which contain example security code
          if grep -ri "password\s*=\|api_key\s*=\|secret\s*=" commands/*.md docs/*.md | grep -v "example\|placeholder\|TODO\|audit-security.md\|audit-live-site.md"; then
            echo "❌ Potential hardcoded secrets found"
            exit 1
          else
            echo "✅ No hardcoded secrets detected"
          fi

      - name: Check for merge conflict markers
        run: |
          if grep -r "^<<<<<<< \|^=======$\|^>>>>>>> " commands/ docs/ 2>/dev/null; then
            echo "❌ Found merge conflict markers"
            exit 1
          else
            echo "✅ No merge conflict markers found"
          fi

  json-yaml-validation:
    name: Validate JSON and YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install validators
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate plugin.json
        run: |
          jq empty .claude-plugin/plugin.json && echo "✅ plugin.json is valid"

      - name: Validate zensical.toml
        run: |
          # Basic TOML validation - check file exists and has required fields
          if [ -f "zensical.toml" ] && grep -q "site_name" zensical.toml && grep -q "docs_dir" zensical.toml; then
            echo "✅ zensical.toml is valid"
          else
            echo "❌ zensical.toml missing or invalid"
            exit 1
          fi

      - name: Validate GitHub Actions workflows
        run: |
          for workflow in .github/workflows/*.yml; do
            echo "Validating $workflow..."
            yq eval "$workflow" > /dev/null && echo "✅ $workflow is valid"
          done
